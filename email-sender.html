<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sender - Long Thanh Phat Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .email-item {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .email-subject {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .email-details {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .webmail-frame {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .no-emails {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .instructions {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h4 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }
        .status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📧 Email Sender</h1>
        <p>Long Thanh Phat Shop - Gửi email qua FTP server</p>
    </div>

    <div class="instructions">
        <h4>📋 Hướng dẫn sử dụng:</h4>
        <ol>
            <li>Nhấn "Test PHP Email" để test gửi email</li>
            <li>Nhấn "Gửi Email Tiếp Theo" để xem email cần gửi</li>
            <li>Nhấn "Gửi Email Này" để gửi email thật</li>
            <li>Nhấn "Đánh dấu đã gửi" sau khi gửi xong</li>
        </ol>
    </div>

    <div class="status">
        <h4>📊 Thống kê</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="text-align: center; padding: 10px; background: #fff3e0; border-radius: 5px;">
                <div style="font-size: 2em; font-weight: bold; color: #f57c00;" id="pendingCount">0</div>
                <div>Chờ gửi</div>
            </div>
            <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                <div style="font-size: 2em; font-weight: bold; color: #388e3c;" id="sentCount">0</div>
                <div>Đã gửi</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <h3>📧 Quản lý emails</h3>
            <button class="btn btn-primary" onclick="testPHPEmail()">🧪 Test PHP Email</button>
            <button class="btn btn-success" onclick="sendNextEmail()">📧 Gửi Email Tiếp Theo</button>
            <button class="btn btn-primary" onclick="refreshEmails()">🔄 Refresh</button>
            
            <div id="currentEmail" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px; display: none;">
                <h4>📧 Email hiện tại:</h4>
                <div id="emailContent"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" onclick="sendCurrentEmail()">📧 Gửi Email Này</button>
                    <button class="btn btn-primary" onclick="markAsSent()">✅ Đánh dấu đã gửi</button>
                    <button class="btn btn-danger" onclick="skipEmail()">⏭️ Bỏ qua</button>
                </div>
            </div>

            <h3>📋 Danh sách emails</h3>
            <div id="emailList" style="max-height: 300px; overflow-y: auto;">
                <div class="no-emails">
                    <p>📭 Không có email nào</p>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>🌐 Webmail Interface</h3>
            <iframe id="webmailFrame" class="webmail-frame" src="https://sng104.arandomserver.com:2096/"></iframe>
        </div>
    </div>

    <div class="log" id="log">
        <div>📧 Email Sender started...</div>
    </div>

    <script>
        let currentEmailIndex = 0;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStats() {
            const emails = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            const pending = emails.filter(e => e.status === 'pending').length;
            const sent = emails.filter(e => e.status === 'sent').length;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('sentCount').textContent = sent;
        }

        async function testPHPEmail() {
            log('🧪 Testing PHP email...');
            
            try {
                const testEmail = {
                    to: 'admin@longthanhphat.store',
                    toName: 'Admin',
                    from: 'admin@longthanhphat.store',
                    fromName: 'Long Thanh Phat Shop',
                    subject: 'Test Email - PHP Mail',
                    message: '<h2>Test Email</h2><p>This is a test email from PHP mail function.</p>',
                    isHtml: true
                };
                
                const response = await fetch('/send-email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testEmail)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log('✅ PHP email test successful!');
                        alert('✅ PHP email test successful!');
                    } else {
                        log(`❌ PHP email test failed: ${result.message}`);
                        alert(`❌ PHP email test failed: ${result.message}`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                log(`❌ PHP email test error: ${error.message}`);
                alert(`❌ PHP email test error: ${error.message}`);
            }
        }

        function sendNextEmail() {
            const emails = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            const pendingEmails = emails.filter(e => e.status === 'pending');
            
            if (pendingEmails.length === 0) {
                alert('📭 Không có email nào chờ gửi!');
                return;
            }
            
            if (currentEmailIndex >= pendingEmails.length) {
                currentEmailIndex = 0;
            }
            
            const email = pendingEmails[currentEmailIndex];
            showCurrentEmail(email);
            log(`📤 Showing email ${currentEmailIndex + 1}/${pendingEmails.length}: ${email.to}`);
        }

        function showCurrentEmail(email) {
            const emailContent = `
                <div style="margin-bottom: 10px;">
                    <strong>Đến:</strong> ${email.to} (${email.toName})
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Từ:</strong> ${email.from} (${email.fromName})
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Tiêu đề:</strong> ${email.subject}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Nội dung:</strong>
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 3px; margin-top: 5px; max-height: 200px; overflow-y: auto;">
                        ${email.body}
                    </div>
                </div>
            `;
            
            document.getElementById('emailContent').innerHTML = emailContent;
            document.getElementById('currentEmail').style.display = 'block';
            
            // Store current email ID
            window.currentEmailId = email.id;
        }

        async function sendCurrentEmail() {
            if (!window.currentEmailId) return;
            
            const emails = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            const email = emails.find(e => e.id === window.currentEmailId);
            
            if (email) {
                log(`📤 Đang gửi email: ${email.to}`);
                
                try {
                    const response = await fetch('/send-email.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            to: email.to,
                            toName: email.toName,
                            from: email.from,
                            fromName: email.fromName,
                            subject: email.subject,
                            message: email.body,
                            isHtml: true
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            email.status = 'sent';
                            email.sentAt = new Date().toISOString();
                            email.sentVia = 'php_mail';
                            localStorage.setItem('pending_emails', JSON.stringify(emails));
                            
                            document.getElementById('currentEmail').style.display = 'none';
                            updateStats();
                            loadEmails();
                            log(`✅ Email gửi thành công: ${email.to}`);
                            alert('✅ Email đã được gửi thành công!');
                        } else {
                            throw new Error(result.message);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    log(`❌ Lỗi gửi email: ${email.to} - ${error.message}`);
                    alert(`❌ Lỗi gửi email: ${error.message}`);
                }
            }
        }

        function markAsSent() {
            if (!window.currentEmailId) return;
            
            const emails = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            const email = emails.find(e => e.id === window.currentEmailId);
            
            if (email) {
                email.status = 'sent';
                email.sentAt = new Date().toISOString();
                email.sentVia = 'manual_mark';
                localStorage.setItem('pending_emails', JSON.stringify(emails));
                
                document.getElementById('currentEmail').style.display = 'none';
                updateStats();
                loadEmails();
                log(`✅ Email marked as sent: ${email.to}`);
                alert('✅ Email đã được đánh dấu là đã gửi!');
            }
        }

        function skipEmail() {
            currentEmailIndex++;
            document.getElementById('currentEmail').style.display = 'none';
            log('⏭️ Email skipped');
        }

        function refreshEmails() {
            updateStats();
            loadEmails();
            log('🔄 Emails refreshed');
        }

        function loadEmails() {
            const emails = JSON.parse(localStorage.getItem('pending_emails') || '[]');
            const emailList = document.getElementById('emailList');
            
            if (emails.length === 0) {
                emailList.innerHTML = '<div class="no-emails"><p>📭 Không có email nào</p></div>';
                return;
            }

            emailList.innerHTML = emails.map(email => `
                <div class="email-item">
                    <div class="email-subject">${email.subject || 'Không có tiêu đề'}</div>
                    <div class="email-details">
                        <strong>Đến:</strong> ${email.to} (${email.toName})<br>
                        <strong>Từ:</strong> ${email.from} (${email.fromName})<br>
                        <strong>Thời gian:</strong> ${new Date(email.timestamp).toLocaleString('vi-VN')}<br>
                        <strong>Trạng thái:</strong> 
                        <span style="color: ${email.status === 'sent' ? 'green' : 'orange'}; font-weight: bold;">
                            ${email.status === 'sent' ? '✅ Đã gửi' : '⏳ Chờ gửi'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        updateStats();
        loadEmails();
        log('🚀 Email Sender initialized');
    </script>
</body>
</html>
